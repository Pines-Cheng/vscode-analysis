<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>VSCode启动流程 | VSCode技术揭秘</title>
    <meta name="description" content="VSCode技术揭秘、VSCode源码解析、VSCode深度定制">
    <link rel="icon" href="/vscode-analysis/logo.ico">
    
    <link rel="preload" href="/vscode-analysis/assets/css/0.styles.b1f351a9.css" as="style"><link rel="preload" href="/vscode-analysis/assets/js/app.1346b767.js" as="script"><link rel="preload" href="/vscode-analysis/assets/js/2.90bbf243.js" as="script"><link rel="preload" href="/vscode-analysis/assets/js/11.149737d3.js" as="script"><link rel="prefetch" href="/vscode-analysis/assets/js/10.e16542e3.js"><link rel="prefetch" href="/vscode-analysis/assets/js/12.1e867180.js"><link rel="prefetch" href="/vscode-analysis/assets/js/13.1513bbd8.js"><link rel="prefetch" href="/vscode-analysis/assets/js/14.00e12222.js"><link rel="prefetch" href="/vscode-analysis/assets/js/15.fd44da96.js"><link rel="prefetch" href="/vscode-analysis/assets/js/16.a6146f2f.js"><link rel="prefetch" href="/vscode-analysis/assets/js/3.6998bd47.js"><link rel="prefetch" href="/vscode-analysis/assets/js/4.3da122f8.js"><link rel="prefetch" href="/vscode-analysis/assets/js/5.a93be29b.js"><link rel="prefetch" href="/vscode-analysis/assets/js/6.d69b3162.js"><link rel="prefetch" href="/vscode-analysis/assets/js/7.71b53d4f.js"><link rel="prefetch" href="/vscode-analysis/assets/js/8.d9813810.js"><link rel="prefetch" href="/vscode-analysis/assets/js/9.72419bfb.js">
    <link rel="stylesheet" href="/vscode-analysis/assets/css/0.styles.b1f351a9.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/vscode-analysis/" class="home-link router-link-active"><!----> <span class="site-name">VSCode技术揭秘</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/vscode-analysis/source/" class="nav-link router-link-active">正文</a></div><div class="nav-item"><a href="/vscode-analysis/learn/" class="nav-link">学习资料</a></div><div class="nav-item"><a href="https://github.com/codeteenager/vscode-analysis" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/vscode-analysis/source/" class="nav-link router-link-active">正文</a></div><div class="nav-item"><a href="/vscode-analysis/learn/" class="nav-link">学习资料</a></div><div class="nav-item"><a href="https://github.com/codeteenager/vscode-analysis" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/vscode-analysis/source/" class="sidebar-link">介绍</a></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>准备工作</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/vscode-analysis/source/tech-prep.html" class="sidebar-link">技术介绍</a></li><li><a href="/vscode-analysis/source/vscode-architecture.html" class="sidebar-link">VSCode架构</a></li><li><a href="/vscode-analysis/source/vscode-environment.html" class="sidebar-link">VSCode源码运行</a></li><li><a href="/vscode-analysis/source/vscode-source-structure.html" class="sidebar-link">VSCode源码结构</a></li><li><a href="/vscode-analysis/source/vscode-start.html" class="active sidebar-link">VSCode启动流程</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>应用定制</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/vscode-analysis/source/app-meta.html" class="sidebar-link">应用信息定制</a></li><li><a href="/vscode-analysis/source/app-icon.html" class="sidebar-link">应用图标定制</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="vscode启动流程"><a href="#vscode启动流程" class="header-anchor">#</a> VSCode启动流程</h1> <p>由于VSCode是基于Electron开发的，Electron的启动入口在package.json中，其中的 main 字段所表示的脚本为应用的启动脚本，它将会在主进程中执行。
<img src="/vscode-analysis/assets/img/vscode-start-one.02522870.png" alt="vscode-start-one">
./out/main.js显然这就是主进程的入口程序，但是main.js是在out文件夹下，很明显是编译输出出来的，然后找到src下tsconfig.json文件中有以下配置：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token string">&quot;outDir&quot;</span><span class="token operator">:</span> <span class="token string">&quot;../out&quot;</span><span class="token punctuation">,</span>
</code></pre></div><p>所以很明显是将src下代码编译后输出到out文件夹中。所以真实入口在src下main.js中，接下来只需从main.js文件分析即可。</p> <p>在main.js中，我们可以看到下面一行引入</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'electron'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>app<span class="token punctuation">;</span>
</code></pre></div><p>electron.app负责管理Electron 应用程序的生命周期，运行在主进程中，然后找到 <strong>ready</strong> 监听事件</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">// Load our code once ready</span>
app<span class="token punctuation">.</span><span class="token function">once</span><span class="token punctuation">(</span><span class="token string">'ready'</span><span class="token punctuation">,</span> function <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>args<span class="token punctuation">[</span><span class="token string">'trace'</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token comment">// @ts-ignore</span>
		<span class="token keyword">const</span> contentTracing <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'electron'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>contentTracing<span class="token punctuation">;</span>

		<span class="token keyword">const</span> traceOptions <span class="token operator">=</span> <span class="token punctuation">{</span>
			categoryFilter<span class="token operator">:</span> args<span class="token punctuation">[</span><span class="token string">'trace-category-filter'</span><span class="token punctuation">]</span> <span class="token operator">||</span> <span class="token string">'*'</span><span class="token punctuation">,</span>
			traceOptions<span class="token operator">:</span> args<span class="token punctuation">[</span><span class="token string">'trace-options'</span><span class="token punctuation">]</span> <span class="token operator">||</span> <span class="token string">'record-until-full,enable-sampling'</span>
		<span class="token punctuation">}</span><span class="token punctuation">;</span>

		contentTracing<span class="token punctuation">.</span><span class="token function">startRecording</span><span class="token punctuation">(</span>traceOptions<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token function">onReady</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
		<span class="token function">onReady</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>这个ready监听表示，Electron 会在初始化后并准备，部分 API 在 ready 事件触发后才能使用。创建窗口也需要在ready后创建。最后这个函数中调用 <strong>onReady()</strong> 函数。</p> <div class="language-java extra-class"><pre class="language-java"><code>function <span class="token function">onReady</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	perf<span class="token punctuation">.</span><span class="token function">mark</span><span class="token punctuation">(</span><span class="token string">'main:appReady'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token class-name">Promise</span><span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span><span class="token punctuation">[</span>nodeCachedDataDir<span class="token punctuation">.</span><span class="token function">ensureExists</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> userDefinedLocale<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">[</span>cachedDataDir<span class="token punctuation">,</span> locale<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>locale <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>nlsConfiguration<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			nlsConfiguration <span class="token operator">=</span> lp<span class="token punctuation">.</span><span class="token function">getNLSConfiguration</span><span class="token punctuation">(</span>product<span class="token punctuation">.</span>commit<span class="token punctuation">,</span> userDataPath<span class="token punctuation">,</span> metaDataFile<span class="token punctuation">,</span> locale<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>

		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>nlsConfiguration<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			nlsConfiguration <span class="token operator">=</span> <span class="token class-name">Promise</span><span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>undefined<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>

		<span class="token comment">// First, we need to test a user defined locale. If it fails we try the app locale.</span>
		<span class="token comment">// If that fails we fall back to English.</span>
		nlsConfiguration<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>nlsConfig <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>

			<span class="token keyword">const</span> startup <span class="token operator">=</span> nlsConfig <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
				nlsConfig<span class="token punctuation">.</span>_languagePackSupport <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
				process<span class="token punctuation">.</span>env<span class="token punctuation">[</span><span class="token string">'VSCODE_NLS_CONFIG'</span><span class="token punctuation">]</span> <span class="token operator">=</span> JSON<span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>nlsConfig<span class="token punctuation">)</span><span class="token punctuation">;</span>
				process<span class="token punctuation">.</span>env<span class="token punctuation">[</span><span class="token string">'VSCODE_NODE_CACHED_DATA_DIR'</span><span class="token punctuation">]</span> <span class="token operator">=</span> cachedDataDir <span class="token operator">||</span> <span class="token string">''</span><span class="token punctuation">;</span>

				<span class="token comment">// Load main in AMD</span>
				perf<span class="token punctuation">.</span><span class="token function">mark</span><span class="token punctuation">(</span><span class="token string">'willLoadMainBundle'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./bootstrap-amd'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span><span class="token string">'vs/code/electron-main/main'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
					perf<span class="token punctuation">.</span><span class="token function">mark</span><span class="token punctuation">(</span><span class="token string">'didLoadMainBundle'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span><span class="token punctuation">;</span>

			<span class="token comment">// We received a valid nlsConfig from a user defined locale</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>nlsConfig<span class="token punctuation">)</span> <span class="token punctuation">{</span>
				<span class="token function">startup</span><span class="token punctuation">(</span>nlsConfig<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>

			<span class="token comment">// Try to use the app locale. Please note that the app locale is only</span>
			<span class="token comment">// valid after we have received the app ready event. This is why the</span>
			<span class="token comment">// code is here.</span>
			<span class="token keyword">else</span> <span class="token punctuation">{</span>
				let appLocale <span class="token operator">=</span> app<span class="token punctuation">.</span><span class="token function">getLocale</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>appLocale<span class="token punctuation">)</span> <span class="token punctuation">{</span>
					<span class="token function">startup</span><span class="token punctuation">(</span><span class="token punctuation">{</span> locale<span class="token operator">:</span> <span class="token string">'en'</span><span class="token punctuation">,</span> availableLanguages<span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>

					<span class="token comment">// See above the comment about the loader and case sensitiviness</span>
					appLocale <span class="token operator">=</span> appLocale<span class="token punctuation">.</span><span class="token function">toLowerCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

					lp<span class="token punctuation">.</span><span class="token function">getNLSConfiguration</span><span class="token punctuation">(</span>product<span class="token punctuation">.</span>commit<span class="token punctuation">,</span> userDataPath<span class="token punctuation">,</span> metaDataFile<span class="token punctuation">,</span> appLocale<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>nlsConfig <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
						<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>nlsConfig<span class="token punctuation">)</span> <span class="token punctuation">{</span>
							nlsConfig <span class="token operator">=</span> <span class="token punctuation">{</span> locale<span class="token operator">:</span> appLocale<span class="token punctuation">,</span> availableLanguages<span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
						<span class="token punctuation">}</span>

						<span class="token function">startup</span><span class="token punctuation">(</span>nlsConfig<span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span><span class="token punctuation">,</span> console<span class="token punctuation">.</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>整个函数读取了用户语言设置，然后最终调用了 <strong>startup()</strong>。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">const</span> startup <span class="token operator">=</span> nlsConfig <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    nlsConfig<span class="token punctuation">.</span>_languagePackSupport <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    process<span class="token punctuation">.</span>env<span class="token punctuation">[</span><span class="token string">'VSCODE_NLS_CONFIG'</span><span class="token punctuation">]</span> <span class="token operator">=</span> JSON<span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>nlsConfig<span class="token punctuation">)</span><span class="token punctuation">;</span>
    process<span class="token punctuation">.</span>env<span class="token punctuation">[</span><span class="token string">'VSCODE_NODE_CACHED_DATA_DIR'</span><span class="token punctuation">]</span> <span class="token operator">=</span> cachedDataDir <span class="token operator">||</span> <span class="token string">''</span><span class="token punctuation">;</span>

    <span class="token comment">// Load main in AMD</span>
    perf<span class="token punctuation">.</span><span class="token function">mark</span><span class="token punctuation">(</span><span class="token string">'willLoadMainBundle'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./bootstrap-amd'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span><span class="token string">'vs/code/electron-main/main'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
        perf<span class="token punctuation">.</span><span class="token function">mark</span><span class="token punctuation">(</span><span class="token string">'didLoadMainBundle'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>startup中主要是引入了 <strong>boostrap-amd</strong> ，这个bootstrap-amd引入了/vs/loader，并创建了一个loader。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">const</span> loader <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./vs/loader'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>loader是微软自家的AMD模块加载开源项目：https://github.com/Microsoft/vscode-loader/</p> <p>然后通过loader加载 <strong>vs/code/electron-main/main</strong> 模块，这是 VSCode 真正的入口，然后在 <strong>vs/code/electron-main/main.ts</strong> 中可以看到定义了一个 <strong>CodeMain</strong> 类，然后初始化这个CodeMain类，并调用了 <strong>main</strong> 函数。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">// src/vs/code/electron-main/main</span>
<span class="token keyword">class</span> <span class="token class-name">CodeMain</span> <span class="token punctuation">{</span>
	<span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span>
		<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
		<span class="token comment">// Launch</span>
		<span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">startup</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">private</span> async <span class="token function">startup</span><span class="token punctuation">(</span>args<span class="token operator">:</span> <span class="token class-name">ParsedArgs</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token class-name">Promise</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token keyword">void</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>

		<span class="token comment">// We need to buffer the spdlog logs until we are sure</span>
		<span class="token comment">// we are the only instance running, otherwise we'll have concurrent</span>
		<span class="token comment">// log file access on Windows (https://github.com/Microsoft/vscode/issues/41218)</span>
		<span class="token keyword">const</span> bufferLogService <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BufferLogService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token keyword">const</span> <span class="token punctuation">[</span>instantiationService<span class="token punctuation">,</span> instanceEnvironment<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">createServices</span><span class="token punctuation">(</span>args<span class="token punctuation">,</span> bufferLogService<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">try</span> <span class="token punctuation">{</span>

			<span class="token comment">// Init services</span>
			await instantiationService<span class="token punctuation">.</span><span class="token function">invokeFunction</span><span class="token punctuation">(</span>async accessor <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
				<span class="token keyword">const</span> environmentService <span class="token operator">=</span> accessor<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token class-name">IEnvironmentService</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token keyword">const</span> configurationService <span class="token operator">=</span> accessor<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token class-name">IConfigurationService</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token keyword">const</span> stateService <span class="token operator">=</span> accessor<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token class-name">IStateService</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

				<span class="token keyword">try</span> <span class="token punctuation">{</span>
					await <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">initServices</span><span class="token punctuation">(</span>environmentService<span class="token punctuation">,</span> configurationService as <span class="token class-name">ConfigurationService</span><span class="token punctuation">,</span> stateService as <span class="token class-name">StateService</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>

					<span class="token comment">// Show a dialog for errors that can be resolved by the user</span>
					<span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">handleStartupDataDirError</span><span class="token punctuation">(</span>environmentService<span class="token punctuation">,</span> error<span class="token punctuation">)</span><span class="token punctuation">;</span>

					<span class="token keyword">throw</span> error<span class="token punctuation">;</span>
				<span class="token punctuation">}</span>
			<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

			<span class="token comment">// Startup</span>
			await instantiationService<span class="token punctuation">.</span><span class="token function">invokeFunction</span><span class="token punctuation">(</span>async accessor <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
				<span class="token keyword">const</span> environmentService <span class="token operator">=</span> accessor<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token class-name">IEnvironmentService</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token keyword">const</span> logService <span class="token operator">=</span> accessor<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token class-name">ILogService</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token keyword">const</span> lifecycleMainService <span class="token operator">=</span> accessor<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token class-name">ILifecycleMainService</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token keyword">const</span> configurationService <span class="token operator">=</span> accessor<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token class-name">IConfigurationService</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

				<span class="token keyword">const</span> mainIpcServer <span class="token operator">=</span> await <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">doStartup</span><span class="token punctuation">(</span>logService<span class="token punctuation">,</span> environmentService<span class="token punctuation">,</span> lifecycleMainService<span class="token punctuation">,</span> instantiationService<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

				bufferLogService<span class="token punctuation">.</span>logger <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SpdLogService</span><span class="token punctuation">(</span><span class="token string">'main'</span><span class="token punctuation">,</span> environmentService<span class="token punctuation">.</span>logsPath<span class="token punctuation">,</span> bufferLogService<span class="token punctuation">.</span><span class="token function">getLevel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token function">once</span><span class="token punctuation">(</span>lifecycleMainService<span class="token punctuation">.</span>onWillShutdown<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token punctuation">(</span>configurationService as <span class="token class-name">ConfigurationService</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">dispose</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

				<span class="token keyword">return</span> instantiationService<span class="token punctuation">.</span><span class="token function">createInstance</span><span class="token punctuation">(</span><span class="token class-name">CodeApplication</span><span class="token punctuation">,</span> mainIpcServer<span class="token punctuation">,</span> instanceEnvironment<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">startup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			instantiationService<span class="token punctuation">.</span><span class="token function">invokeFunction</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>quit<span class="token punctuation">,</span> error<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">private</span> <span class="token function">createServices</span><span class="token punctuation">(</span>args<span class="token operator">:</span> <span class="token class-name">ParsedArgs</span><span class="token punctuation">,</span> bufferLogService<span class="token operator">:</span> <span class="token class-name">BufferLogService</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token class-name">IInstantiationService</span><span class="token punctuation">,</span> typeof process<span class="token punctuation">.</span>env<span class="token punctuation">]</span> <span class="token punctuation">{</span>
		<span class="token keyword">const</span> services <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ServiceCollection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token keyword">const</span> environmentService <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">EnvironmentService</span><span class="token punctuation">(</span>args<span class="token punctuation">,</span> process<span class="token punctuation">.</span>execPath<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">const</span> instanceEnvironment <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">patchEnvironment</span><span class="token punctuation">(</span>environmentService<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Patch `process.env` with the instance's environment</span>
		services<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token class-name">IEnvironmentService</span><span class="token punctuation">,</span> environmentService<span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token keyword">const</span> logService <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MultiplexLogService</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token keyword">new</span> <span class="token class-name">ConsoleLogMainService</span><span class="token punctuation">(</span><span class="token function">getLogLevel</span><span class="token punctuation">(</span>environmentService<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> bufferLogService<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		process<span class="token punctuation">.</span><span class="token function">once</span><span class="token punctuation">(</span><span class="token string">'exit'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> logService<span class="token punctuation">.</span><span class="token function">dispose</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		services<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token class-name">ILogService</span><span class="token punctuation">,</span> logService<span class="token punctuation">)</span><span class="token punctuation">;</span>

		services<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token class-name">IConfigurationService</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">ConfigurationService</span><span class="token punctuation">(</span>environmentService<span class="token punctuation">.</span>settingsResource<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		services<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token class-name">ILifecycleMainService</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">SyncDescriptor</span><span class="token punctuation">(</span><span class="token class-name">LifecycleMainService</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		services<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token class-name">IStateService</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">SyncDescriptor</span><span class="token punctuation">(</span><span class="token class-name">StateService</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		services<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token class-name">IRequestService</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">SyncDescriptor</span><span class="token punctuation">(</span><span class="token class-name">RequestMainService</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		services<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token class-name">IThemeMainService</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">SyncDescriptor</span><span class="token punctuation">(</span><span class="token class-name">ThemeMainService</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		services<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token class-name">ISignService</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">SyncDescriptor</span><span class="token punctuation">(</span><span class="token class-name">SignService</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token keyword">return</span> <span class="token punctuation">[</span><span class="token keyword">new</span> <span class="token class-name">InstantiationService</span><span class="token punctuation">(</span>services<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">,</span> instanceEnvironment<span class="token punctuation">]</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>

<span class="token comment">// Main Startup</span>
<span class="token keyword">const</span> code <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CodeMain</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
code<span class="token punctuation">.</span><span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>可以看到 <strong>main()</strong> 函数最终调用了 <strong>startup()</strong> 函数。</p> <p>在 <strong>startup()</strong> 函数中，先调用了 <strong>this.createServices()</strong> 函数来创建依赖的Services。
Services(服务) 是 VSCode 中一系列可以被注入的公共模块，这些 Services 分别负责不同的功能，在这里创建了几个基本服务。除了这些基本服务，VSCode 内还包含了大量的服务，如 IModeService、ICodeEditorService、IPanelService 等，通过 VSCode 实现的「依赖注入」模式，可以在需要用到这些服务的地方以 Decorator 的方式做为构造函数参数声明依赖，会被自动注入到类中。关于服务的依赖注入，后面的章节会重点讲解。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">private</span> <span class="token function">createServices</span><span class="token punctuation">(</span>args<span class="token punctuation">:</span> ParsedArgs<span class="token punctuation">,</span> bufferLogService<span class="token punctuation">:</span> BufferLogService<span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>IInstantiationService<span class="token punctuation">,</span> <span class="token keyword">typeof</span> process<span class="token punctuation">.</span>env<span class="token punctuation">]</span> <span class="token punctuation">{</span>
		<span class="token keyword">const</span> services <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ServiceCollection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token keyword">const</span> environmentService <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">EnvironmentService</span><span class="token punctuation">(</span>args<span class="token punctuation">,</span> process<span class="token punctuation">.</span>execPath<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">const</span> instanceEnvironment <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">patchEnvironment</span><span class="token punctuation">(</span>environmentService<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Patch `process.env` with the instance's environment</span>
		<span class="token comment">// environmentService 一些基本配置，包括运行目录、用户数据目录、工作区缓存目录等</span>
		services<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>IEnvironmentService<span class="token punctuation">,</span> environmentService<span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token keyword">const</span> logService <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MultiplexLogService</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token keyword">new</span> <span class="token class-name">ConsoleLogMainService</span><span class="token punctuation">(</span><span class="token function">getLogLevel</span><span class="token punctuation">(</span>environmentService<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> bufferLogService<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		process<span class="token punctuation">.</span><span class="token function">once</span><span class="token punctuation">(</span><span class="token string">'exit'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> logService<span class="token punctuation">.</span><span class="token function">dispose</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">// logService 日志服务</span>
		services<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>ILogService<span class="token punctuation">,</span> logService<span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token comment">// ConfigurationService 配置项</span>
		services<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>IConfigurationService<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">ConfigurationService</span><span class="token punctuation">(</span>environmentService<span class="token punctuation">.</span>settingsResource<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">// LifecycleService 生命周期相关的一些方法</span>
		services<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>ILifecycleMainService<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">SyncDescriptor</span><span class="token punctuation">(</span>LifecycleMainService<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">// StateService 持久化数据</span>
		services<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>IStateService<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">SyncDescriptor</span><span class="token punctuation">(</span>StateService<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">// RequestService 请求服务</span>
		services<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>IRequestService<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">SyncDescriptor</span><span class="token punctuation">(</span>RequestMainService<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		services<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>IThemeMainService<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">SyncDescriptor</span><span class="token punctuation">(</span>ThemeMainService<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		services<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>ISignService<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">SyncDescriptor</span><span class="token punctuation">(</span>SignService<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token keyword">return</span> <span class="token punctuation">[</span><span class="token keyword">new</span> <span class="token class-name">InstantiationService</span><span class="token punctuation">(</span>services<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">,</span> instanceEnvironment<span class="token punctuation">]</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
</code></pre></div><p>代码中可以看到 <strong>createServices()</strong> 最终实例化了一个 <strong>InstantiationService</strong> 实例并return回去，然后在 <strong>startup()</strong> 中调用 InstantiationService的createInstance方法并传参数CodeApplication，表示初始化CodeApplication实例，然后调用实例的 <strong>startup()</strong> 方法。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">return</span> instantiationService<span class="token punctuation">.</span><span class="token function">createInstance</span><span class="token punctuation">(</span>CodeApplication<span class="token punctuation">,</span> mainIpcServer<span class="token punctuation">,</span>instanceEnvironment<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">startup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>接下来我们去看CodeApplication中的startup方法。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">//src/vs/code/electron-main/app.ts</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">CodeApplication</span> <span class="token keyword">extends</span> <span class="token class-name">Disposable</span> <span class="token punctuation">{</span>
	<span class="token operator">...</span>
	<span class="token keyword">async</span> <span class="token function">startup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span> Promise<span class="token operator">&lt;</span><span class="token keyword">void</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
		<span class="token keyword">this</span><span class="token punctuation">.</span>logService<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">'Starting VS Code'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">this</span><span class="token punctuation">.</span>logService<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">from: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token keyword">this</span><span class="token punctuation">.</span>environmentService<span class="token punctuation">.</span>appRoot<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">this</span><span class="token punctuation">.</span>logService<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">'args:'</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>environmentService<span class="token punctuation">.</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token comment">// Make sure we associate the program with the app user model id</span>
		<span class="token comment">// This will help Windows to associate the running program with</span>
		<span class="token comment">// any shortcut that is pinned to the taskbar and prevent showing</span>
		<span class="token comment">// two icons in the taskbar for the same app.</span>
		<span class="token keyword">const</span> win32AppUserModelId <span class="token operator">=</span> product<span class="token punctuation">.</span>win32AppUserModelId<span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>isWindows <span class="token operator">&amp;&amp;</span> win32AppUserModelId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			app<span class="token punctuation">.</span><span class="token function">setAppUserModelId</span><span class="token punctuation">(</span>win32AppUserModelId<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>

		<span class="token comment">// Fix native tabs on macOS 10.13</span>
		<span class="token comment">// macOS enables a compatibility patch for any bundle ID beginning with</span>
		<span class="token comment">// &quot;com.microsoft.&quot;, which breaks native tabs for VS Code when using this</span>
		<span class="token comment">// identifier (from the official build).</span>
		<span class="token comment">// Explicitly opt out of the patch here before creating any windows.</span>
		<span class="token comment">// See: https://github.com/Microsoft/vscode/issues/35361#issuecomment-399794085</span>
		<span class="token keyword">try</span> <span class="token punctuation">{</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>isMacintosh <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>configurationService<span class="token punctuation">.</span>getValue<span class="token operator">&lt;</span>boolean<span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token string">'window.nativeTabs'</span><span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token boolean">true</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>systemPreferences<span class="token punctuation">.</span><span class="token function">getUserDefault</span><span class="token punctuation">(</span><span class="token string">'NSUseImprovedLayoutPass'</span><span class="token punctuation">,</span> <span class="token string">'boolean'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
				systemPreferences<span class="token punctuation">.</span><span class="token function">setUserDefault</span><span class="token punctuation">(</span><span class="token string">'NSUseImprovedLayoutPass'</span><span class="token punctuation">,</span> <span class="token string">'boolean'</span><span class="token punctuation">,</span> <span class="token boolean">true</span> <span class="token keyword">as</span> any<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token keyword">this</span><span class="token punctuation">.</span>logService<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>

		<span class="token comment">// Create Electron IPC Server</span>
		<span class="token keyword">const</span> electronIpcServer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ElectronIPCServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token comment">// Resolve unique machine ID</span>
		<span class="token keyword">this</span><span class="token punctuation">.</span>logService<span class="token punctuation">.</span><span class="token function">trace</span><span class="token punctuation">(</span><span class="token string">'Resolving machine identifier...'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">const</span> <span class="token punctuation">{</span> machineId<span class="token punctuation">,</span> trueMachineId <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">resolveMachineId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">this</span><span class="token punctuation">.</span>logService<span class="token punctuation">.</span><span class="token function">trace</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Resolved machine identifier: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>machineId<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> (trueMachineId: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>trueMachineId<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">)</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token comment">// Spawn shared process after the first window has opened and 3s have passed</span>
		<span class="token keyword">const</span> sharedProcess <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>instantiationService<span class="token punctuation">.</span><span class="token function">createInstance</span><span class="token punctuation">(</span>SharedProcess<span class="token punctuation">,</span> machineId<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>userEnv<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">const</span> sharedProcessClient <span class="token operator">=</span> sharedProcess<span class="token punctuation">.</span><span class="token function">whenReady</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">connect</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>environmentService<span class="token punctuation">.</span>sharedIPCHandle<span class="token punctuation">,</span> <span class="token string">'main'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">this</span><span class="token punctuation">.</span>lifecycleMainService<span class="token punctuation">.</span><span class="token function">when</span><span class="token punctuation">(</span>LifecycleMainPhase<span class="token punctuation">.</span>AfterWindowOpen<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
			<span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_register</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">RunOnceScheduler</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
				<span class="token keyword">const</span> userEnv <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">getShellEnvironment</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>logService<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>environmentService<span class="token punctuation">)</span><span class="token punctuation">;</span>

				sharedProcess<span class="token punctuation">.</span><span class="token function">spawn</span><span class="token punctuation">(</span>userEnv<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">3000</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">schedule</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token comment">// Services</span>
		<span class="token keyword">const</span> appInstantiationService <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">createServices</span><span class="token punctuation">(</span>machineId<span class="token punctuation">,</span> trueMachineId<span class="token punctuation">,</span> sharedProcess<span class="token punctuation">,</span> sharedProcessClient<span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token comment">// Create driver</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>environmentService<span class="token punctuation">.</span>driverHandle<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token keyword">const</span> server <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">serveDriver</span><span class="token punctuation">(</span>electronIpcServer<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>environmentService<span class="token punctuation">.</span>driverHandle<span class="token operator">!</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>environmentService<span class="token punctuation">,</span> appInstantiationService<span class="token punctuation">)</span><span class="token punctuation">;</span>

			<span class="token keyword">this</span><span class="token punctuation">.</span>logService<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">'Driver started at:'</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>environmentService<span class="token punctuation">.</span>driverHandle<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_register</span><span class="token punctuation">(</span>server<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>

		<span class="token comment">// Setup Auth Handler</span>
		<span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_register</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ProxyAuthHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token comment">// Open Windows</span>
		<span class="token keyword">const</span> windows <span class="token operator">=</span> appInstantiationService<span class="token punctuation">.</span><span class="token function">invokeFunction</span><span class="token punctuation">(</span><span class="token parameter">accessor</span> <span class="token operator">=&gt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">openFirstWindow</span><span class="token punctuation">(</span>accessor<span class="token punctuation">,</span> electronIpcServer<span class="token punctuation">,</span> sharedProcessClient<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token comment">// Post Open Windows Tasks</span>
		<span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">afterWindowOpen</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token comment">// Tracing: Stop tracing after windows are ready if enabled</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>environmentService<span class="token punctuation">.</span>args<span class="token punctuation">.</span>trace<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">stopTracingEventually</span><span class="token punctuation">(</span>windows<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>

	<span class="token operator">...</span>

	<span class="token keyword">private</span> <span class="token function">openFirstWindow</span><span class="token punctuation">(</span>accessor<span class="token punctuation">:</span> ServicesAccessor<span class="token punctuation">,</span> electronIpcServer<span class="token punctuation">:</span> ElectronIPCServer<span class="token punctuation">,</span> sharedProcessClient<span class="token punctuation">:</span> Promise<span class="token operator">&lt;</span>Client<span class="token operator">&lt;</span>string<span class="token operator">&gt;&gt;</span><span class="token punctuation">)</span><span class="token punctuation">:</span> ICodeWindow<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">{</span>

		<span class="token comment">// Register more Main IPC services</span>
		<span class="token keyword">const</span> launchMainService <span class="token operator">=</span> accessor<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>ILaunchMainService<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">const</span> launchChannel <span class="token operator">=</span> <span class="token function">createChannelReceiver</span><span class="token punctuation">(</span>launchMainService<span class="token punctuation">,</span> <span class="token punctuation">{</span> disableMarshalling<span class="token punctuation">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">this</span><span class="token punctuation">.</span>mainIpcServer<span class="token punctuation">.</span><span class="token function">registerChannel</span><span class="token punctuation">(</span><span class="token string">'launch'</span><span class="token punctuation">,</span> launchChannel<span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token comment">// Register more Electron IPC services</span>
		<span class="token keyword">const</span> updateService <span class="token operator">=</span> accessor<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>IUpdateService<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">const</span> updateChannel <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">UpdateChannel</span><span class="token punctuation">(</span>updateService<span class="token punctuation">)</span><span class="token punctuation">;</span>
		electronIpcServer<span class="token punctuation">.</span><span class="token function">registerChannel</span><span class="token punctuation">(</span><span class="token string">'update'</span><span class="token punctuation">,</span> updateChannel<span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token keyword">const</span> issueService <span class="token operator">=</span> accessor<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>IIssueService<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">const</span> issueChannel <span class="token operator">=</span> <span class="token function">createChannelReceiver</span><span class="token punctuation">(</span>issueService<span class="token punctuation">)</span><span class="token punctuation">;</span>
		electronIpcServer<span class="token punctuation">.</span><span class="token function">registerChannel</span><span class="token punctuation">(</span><span class="token string">'issue'</span><span class="token punctuation">,</span> issueChannel<span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token keyword">const</span> electronService <span class="token operator">=</span> accessor<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>IElectronService<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">const</span> electronChannel <span class="token operator">=</span> <span class="token function">createChannelReceiver</span><span class="token punctuation">(</span>electronService<span class="token punctuation">)</span><span class="token punctuation">;</span>
		electronIpcServer<span class="token punctuation">.</span><span class="token function">registerChannel</span><span class="token punctuation">(</span><span class="token string">'electron'</span><span class="token punctuation">,</span> electronChannel<span class="token punctuation">)</span><span class="token punctuation">;</span>
		sharedProcessClient<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">client</span> <span class="token operator">=&gt;</span> client<span class="token punctuation">.</span><span class="token function">registerChannel</span><span class="token punctuation">(</span><span class="token string">'electron'</span><span class="token punctuation">,</span> electronChannel<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token keyword">const</span> sharedProcessMainService <span class="token operator">=</span> accessor<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>ISharedProcessMainService<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">const</span> sharedProcessChannel <span class="token operator">=</span> <span class="token function">createChannelReceiver</span><span class="token punctuation">(</span>sharedProcessMainService<span class="token punctuation">)</span><span class="token punctuation">;</span>
		electronIpcServer<span class="token punctuation">.</span><span class="token function">registerChannel</span><span class="token punctuation">(</span><span class="token string">'sharedProcess'</span><span class="token punctuation">,</span> sharedProcessChannel<span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token keyword">const</span> workspacesService <span class="token operator">=</span> accessor<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>IWorkspacesService<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">const</span> workspacesChannel <span class="token operator">=</span> <span class="token function">createChannelReceiver</span><span class="token punctuation">(</span>workspacesService<span class="token punctuation">)</span><span class="token punctuation">;</span>
		electronIpcServer<span class="token punctuation">.</span><span class="token function">registerChannel</span><span class="token punctuation">(</span><span class="token string">'workspaces'</span><span class="token punctuation">,</span> workspacesChannel<span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token keyword">const</span> menubarService <span class="token operator">=</span> accessor<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>IMenubarService<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">const</span> menubarChannel <span class="token operator">=</span> <span class="token function">createChannelReceiver</span><span class="token punctuation">(</span>menubarService<span class="token punctuation">)</span><span class="token punctuation">;</span>
		electronIpcServer<span class="token punctuation">.</span><span class="token function">registerChannel</span><span class="token punctuation">(</span><span class="token string">'menubar'</span><span class="token punctuation">,</span> menubarChannel<span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token keyword">const</span> urlService <span class="token operator">=</span> accessor<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>IURLService<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">const</span> urlChannel <span class="token operator">=</span> <span class="token function">createChannelReceiver</span><span class="token punctuation">(</span>urlService<span class="token punctuation">)</span><span class="token punctuation">;</span>
		electronIpcServer<span class="token punctuation">.</span><span class="token function">registerChannel</span><span class="token punctuation">(</span><span class="token string">'url'</span><span class="token punctuation">,</span> urlChannel<span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token keyword">const</span> storageMainService <span class="token operator">=</span> accessor<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>IStorageMainService<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">const</span> storageChannel <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_register</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">GlobalStorageDatabaseChannel</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>logService<span class="token punctuation">,</span> storageMainService<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		electronIpcServer<span class="token punctuation">.</span><span class="token function">registerChannel</span><span class="token punctuation">(</span><span class="token string">'storage'</span><span class="token punctuation">,</span> storageChannel<span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token keyword">const</span> loggerChannel <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LoggerChannel</span><span class="token punctuation">(</span>accessor<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>ILogService<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		electronIpcServer<span class="token punctuation">.</span><span class="token function">registerChannel</span><span class="token punctuation">(</span><span class="token string">'logger'</span><span class="token punctuation">,</span> loggerChannel<span class="token punctuation">)</span><span class="token punctuation">;</span>
		sharedProcessClient<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">client</span> <span class="token operator">=&gt;</span> client<span class="token punctuation">.</span><span class="token function">registerChannel</span><span class="token punctuation">(</span><span class="token string">'logger'</span><span class="token punctuation">,</span> loggerChannel<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token comment">// ExtensionHost Debug broadcast service</span>
		electronIpcServer<span class="token punctuation">.</span><span class="token function">registerChannel</span><span class="token punctuation">(</span>ExtensionHostDebugBroadcastChannel<span class="token punctuation">.</span>ChannelName<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">ExtensionHostDebugBroadcastChannel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token comment">// Signal phase: ready (services set)</span>
		<span class="token keyword">this</span><span class="token punctuation">.</span>lifecycleMainService<span class="token punctuation">.</span>phase <span class="token operator">=</span> LifecycleMainPhase<span class="token punctuation">.</span>Ready<span class="token punctuation">;</span>

		<span class="token comment">// Propagate to clients</span>
		<span class="token keyword">const</span> windowsMainService <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>windowsMainService <span class="token operator">=</span> accessor<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>IWindowsMainService<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">this</span><span class="token punctuation">.</span>dialogMainService <span class="token operator">=</span> accessor<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>IDialogMainService<span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token comment">// Create a URL handler to open file URIs in the active window</span>
		<span class="token keyword">const</span> environmentService <span class="token operator">=</span> accessor<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>IEnvironmentService<span class="token punctuation">)</span><span class="token punctuation">;</span>
		urlService<span class="token punctuation">.</span><span class="token function">registerHandler</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
			<span class="token keyword">async</span> <span class="token function">handleURL</span><span class="token punctuation">(</span>uri<span class="token punctuation">:</span> <span class="token constant">URI</span><span class="token punctuation">,</span> options<span class="token operator">?</span><span class="token punctuation">:</span> IOpenURLOptions<span class="token punctuation">)</span><span class="token punctuation">:</span> Promise<span class="token operator">&lt;</span>boolean<span class="token operator">&gt;</span> <span class="token punctuation">{</span>

				<span class="token comment">// Catch file URLs</span>
				<span class="token keyword">if</span> <span class="token punctuation">(</span>uri<span class="token punctuation">.</span>authority <span class="token operator">===</span> Schemas<span class="token punctuation">.</span>file <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token operator">!</span>uri<span class="token punctuation">.</span>path<span class="token punctuation">)</span> <span class="token punctuation">{</span>
					<span class="token keyword">const</span> cli <span class="token operator">=</span> <span class="token function">assign</span><span class="token punctuation">(</span>Object<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">,</span> environmentService<span class="token punctuation">.</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token keyword">const</span> urisToOpen <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">{</span> fileUri<span class="token punctuation">:</span> <span class="token constant">URI</span><span class="token punctuation">.</span><span class="token function">file</span><span class="token punctuation">(</span>uri<span class="token punctuation">.</span>fsPath<span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

					windowsMainService<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token punctuation">{</span> context<span class="token punctuation">:</span> OpenContext<span class="token punctuation">.</span><span class="token constant">API</span><span class="token punctuation">,</span> cli<span class="token punctuation">,</span> urisToOpen<span class="token punctuation">,</span> gotoLineMode<span class="token punctuation">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

					<span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span>

				<span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token comment">// Create a URL handler which forwards to the last active window</span>
		<span class="token keyword">const</span> activeWindowManager <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ActiveWindowManager</span><span class="token punctuation">(</span>electronService<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">const</span> activeWindowRouter <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StaticRouter</span><span class="token punctuation">(</span><span class="token parameter">ctx</span> <span class="token operator">=&gt;</span> activeWindowManager<span class="token punctuation">.</span><span class="token function">getActiveClientId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">id</span> <span class="token operator">=&gt;</span> ctx <span class="token operator">===</span> id<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">const</span> urlHandlerRouter <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">URLHandlerRouter</span><span class="token punctuation">(</span>activeWindowRouter<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">const</span> urlHandlerChannel <span class="token operator">=</span> electronIpcServer<span class="token punctuation">.</span><span class="token function">getChannel</span><span class="token punctuation">(</span><span class="token string">'urlHandler'</span><span class="token punctuation">,</span> urlHandlerRouter<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">const</span> multiplexURLHandler <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">URLHandlerChannelClient</span><span class="token punctuation">(</span>urlHandlerChannel<span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token comment">// On Mac, Code can be running without any open windows, so we must create a window to handle urls,</span>
		<span class="token comment">// if there is none</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>isMacintosh<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			urlService<span class="token punctuation">.</span><span class="token function">registerHandler</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
				<span class="token keyword">async</span> <span class="token function">handleURL</span><span class="token punctuation">(</span>uri<span class="token punctuation">:</span> <span class="token constant">URI</span><span class="token punctuation">,</span> options<span class="token operator">?</span><span class="token punctuation">:</span> IOpenURLOptions<span class="token punctuation">)</span><span class="token punctuation">:</span> Promise<span class="token operator">&lt;</span>boolean<span class="token operator">&gt;</span> <span class="token punctuation">{</span>
					<span class="token keyword">if</span> <span class="token punctuation">(</span>windowsMainService<span class="token punctuation">.</span><span class="token function">getWindowCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
						<span class="token keyword">const</span> cli <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token operator">...</span>environmentService<span class="token punctuation">.</span>args <span class="token punctuation">}</span><span class="token punctuation">;</span>
						<span class="token keyword">const</span> <span class="token punctuation">[</span>window<span class="token punctuation">]</span> <span class="token operator">=</span> windowsMainService<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token punctuation">{</span> context<span class="token punctuation">:</span> OpenContext<span class="token punctuation">.</span><span class="token constant">API</span><span class="token punctuation">,</span> cli<span class="token punctuation">,</span> forceEmpty<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> gotoLineMode<span class="token punctuation">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

						<span class="token keyword">await</span> window<span class="token punctuation">.</span><span class="token function">ready</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

						<span class="token keyword">return</span> urlService<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span>uri<span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token punctuation">}</span>

					<span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span>
			<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>

		<span class="token comment">// Register the multiple URL handler</span>
		urlService<span class="token punctuation">.</span><span class="token function">registerHandler</span><span class="token punctuation">(</span>multiplexURLHandler<span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token comment">// Watch Electron URLs and forward them to the UrlService</span>
		<span class="token keyword">const</span> args <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>environmentService<span class="token punctuation">.</span>args<span class="token punctuation">;</span>
		<span class="token keyword">const</span> urls <span class="token operator">=</span> args<span class="token punctuation">[</span><span class="token string">'open-url'</span><span class="token punctuation">]</span> <span class="token operator">?</span> args<span class="token punctuation">.</span>_urls <span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
		<span class="token keyword">const</span> urlListener <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ElectronURLListener</span><span class="token punctuation">(</span>urls <span class="token operator">||</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> urlService<span class="token punctuation">,</span> windowsMainService<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_register</span><span class="token punctuation">(</span>urlListener<span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token comment">// Open our first window</span>
		<span class="token keyword">const</span> macOpenFiles<span class="token punctuation">:</span> string<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">&lt;</span>any<span class="token operator">&gt;</span>global<span class="token punctuation">)</span><span class="token punctuation">.</span>macOpenFiles<span class="token punctuation">;</span>
		<span class="token keyword">const</span> context <span class="token operator">=</span> <span class="token operator">!</span><span class="token operator">!</span>process<span class="token punctuation">.</span>env<span class="token punctuation">[</span><span class="token string">'VSCODE_CLI'</span><span class="token punctuation">]</span> <span class="token operator">?</span> OpenContext<span class="token punctuation">.</span><span class="token constant">CLI</span> <span class="token punctuation">:</span> OpenContext<span class="token punctuation">.</span><span class="token constant">DESKTOP</span><span class="token punctuation">;</span>
		<span class="token keyword">const</span> hasCliArgs <span class="token operator">=</span> args<span class="token punctuation">.</span>_<span class="token punctuation">.</span>length<span class="token punctuation">;</span>
		<span class="token keyword">const</span> hasFolderURIs <span class="token operator">=</span> <span class="token operator">!</span><span class="token operator">!</span>args<span class="token punctuation">[</span><span class="token string">'folder-uri'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
		<span class="token keyword">const</span> hasFileURIs <span class="token operator">=</span> <span class="token operator">!</span><span class="token operator">!</span>args<span class="token punctuation">[</span><span class="token string">'file-uri'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
		<span class="token keyword">const</span> noRecentEntry <span class="token operator">=</span> args<span class="token punctuation">[</span><span class="token string">'skip-add-to-recently-opened'</span><span class="token punctuation">]</span> <span class="token operator">===</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
		<span class="token keyword">const</span> waitMarkerFileURI <span class="token operator">=</span> args<span class="token punctuation">.</span>wait <span class="token operator">&amp;&amp;</span> args<span class="token punctuation">.</span>waitMarkerFilePath <span class="token operator">?</span> <span class="token constant">URI</span><span class="token punctuation">.</span><span class="token function">file</span><span class="token punctuation">(</span>args<span class="token punctuation">.</span>waitMarkerFilePath<span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span>

		<span class="token comment">// new window if &quot;-n&quot; was used without paths</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>args<span class="token punctuation">[</span><span class="token string">'new-window'</span><span class="token punctuation">]</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>hasCliArgs <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>hasFolderURIs <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>hasFileURIs<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token keyword">return</span> windowsMainService<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
				context<span class="token punctuation">,</span>
				cli<span class="token punctuation">:</span> args<span class="token punctuation">,</span>
				forceNewWindow<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
				forceEmpty<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
				noRecentEntry<span class="token punctuation">,</span>
				waitMarkerFileURI<span class="token punctuation">,</span>
				initialStartup<span class="token punctuation">:</span> <span class="token boolean">true</span>
			<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>

		<span class="token comment">// mac: open-file event received on startup</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>macOpenFiles <span class="token operator">&amp;&amp;</span> macOpenFiles<span class="token punctuation">.</span>length <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>hasCliArgs <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>hasFolderURIs <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>hasFileURIs<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token keyword">return</span> windowsMainService<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
				context<span class="token punctuation">:</span> OpenContext<span class="token punctuation">.</span><span class="token constant">DOCK</span><span class="token punctuation">,</span>
				cli<span class="token punctuation">:</span> args<span class="token punctuation">,</span>
				urisToOpen<span class="token punctuation">:</span> macOpenFiles<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">file</span> <span class="token operator">=&gt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getWindowOpenableFromPathSync</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
				noRecentEntry<span class="token punctuation">,</span>
				waitMarkerFileURI<span class="token punctuation">,</span>
				gotoLineMode<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
				initialStartup<span class="token punctuation">:</span> <span class="token boolean">true</span>
			<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>

		<span class="token comment">// default: read paths from cli</span>
		<span class="token keyword">return</span> windowsMainService<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
			context<span class="token punctuation">,</span>
			cli<span class="token punctuation">:</span> args<span class="token punctuation">,</span>
			forceNewWindow<span class="token punctuation">:</span> args<span class="token punctuation">[</span><span class="token string">'new-window'</span><span class="token punctuation">]</span> <span class="token operator">||</span> <span class="token punctuation">(</span><span class="token operator">!</span>hasCliArgs <span class="token operator">&amp;&amp;</span> args<span class="token punctuation">[</span><span class="token string">'unity-launch'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
			diffMode<span class="token punctuation">:</span> args<span class="token punctuation">.</span>diff<span class="token punctuation">,</span>
			noRecentEntry<span class="token punctuation">,</span>
			waitMarkerFileURI<span class="token punctuation">,</span>
			gotoLineMode<span class="token punctuation">:</span> args<span class="token punctuation">.</span>goto<span class="token punctuation">,</span>
			initialStartup<span class="token punctuation">:</span> <span class="token boolean">true</span>
		<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token operator">...</span>
<span class="token punctuation">}</span>
</code></pre></div><p>在CodeApplication.startup 中首先会启动 SharedProcess 共享进程，同时也创建了一些窗口相关的服务，包括 WindowsManager、WindowsService、MenubarService 等，负责窗口、多窗口管理及菜单等功能。然后调用 <strong>openFirstWindow</strong> 方法来开启窗口。</p> <p>在openFirstWindow中，先创建一系列 Electron 的 IPC 频道，用于主进程和渲染进程间通信，其中 window 和 logLevel 频道还会被注册到 sharedProcessClient ，sharedProcessClient 是主进程与共享进程（SharedProcess）进行通信的 client，之后根据 environmentService 提供的相关参数（file_uri、folder_uri）调用了 windowsMainService.open 方法。</p> <p>windowsMainService是WindowsManager实例化的服务，而WindowsManager是多窗体管理类（src/vs/code/electron-main/windows.ts）。接下来我们看windowsMainService.open 方法，可以看到其调用了doOpen方法。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function">open</span><span class="token punctuation">(</span>openConfig<span class="token punctuation">:</span> IOpenConfiguration<span class="token punctuation">)</span><span class="token punctuation">:</span> ICodeWindow<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">{</span>
		<span class="token operator">...</span>

		<span class="token comment">// Open based on config</span>
		<span class="token keyword">const</span> usedWindows <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">doOpen</span><span class="token punctuation">(</span>openConfig<span class="token punctuation">,</span> workspacesToOpen<span class="token punctuation">,</span> foldersToOpen<span class="token punctuation">,</span> 
		<span class="token operator">...</span>
	<span class="token punctuation">}</span>

</code></pre></div><p>doOpen方法最终调用了openInBrowserWindow方法。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">private</span> <span class="token function">doOpen</span><span class="token punctuation">(</span>
		<span class="token parameter">openConfig<span class="token punctuation">:</span> IOpenConfiguration<span class="token punctuation">,</span>
		workspacesToOpen<span class="token punctuation">:</span> IWorkspacePathToOpen<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
		foldersToOpen<span class="token punctuation">:</span> IFolderPathToOpen<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
		emptyToRestore<span class="token punctuation">:</span> IEmptyWindowBackupInfo<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
		emptyToOpen<span class="token punctuation">:</span> number<span class="token punctuation">,</span>
		fileInputs<span class="token punctuation">:</span> IFileInputs <span class="token operator">|</span> <span class="token keyword">undefined</span><span class="token punctuation">,</span>
		foldersToAdd<span class="token punctuation">:</span> IFolderPathToOpen<span class="token punctuation">[</span><span class="token punctuation">]</span></span>
	<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">const</span> usedWindows<span class="token punctuation">:</span> ICodeWindow<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

		<span class="token operator">...</span>

		<span class="token comment">// Handle empty to open (only if no other window opened)</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>usedWindows<span class="token punctuation">.</span>length <span class="token operator">===</span> <span class="token number">0</span> <span class="token operator">||</span> fileInputs<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>fileInputs <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>emptyToOpen<span class="token punctuation">)</span> <span class="token punctuation">{</span>
				emptyToOpen<span class="token operator">++</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>

			<span class="token keyword">const</span> remoteAuthority <span class="token operator">=</span> fileInputs <span class="token operator">?</span> fileInputs<span class="token punctuation">.</span>remoteAuthority <span class="token punctuation">:</span> <span class="token punctuation">(</span>openConfig<span class="token punctuation">.</span>cli <span class="token operator">&amp;&amp;</span> openConfig<span class="token punctuation">.</span>cli<span class="token punctuation">.</span>remote <span class="token operator">||</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

			<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> emptyToOpen<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
				usedWindows<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">openInBrowserWindow</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
					userEnv<span class="token punctuation">:</span> openConfig<span class="token punctuation">.</span>userEnv<span class="token punctuation">,</span>
					cli<span class="token punctuation">:</span> openConfig<span class="token punctuation">.</span>cli<span class="token punctuation">,</span>
					initialStartup<span class="token punctuation">:</span> openConfig<span class="token punctuation">.</span>initialStartup<span class="token punctuation">,</span>
					remoteAuthority<span class="token punctuation">,</span>
					forceNewWindow<span class="token punctuation">:</span> openFolderInNewWindow<span class="token punctuation">,</span>
					forceNewTabbedWindow<span class="token punctuation">:</span> openConfig<span class="token punctuation">.</span>forceNewTabbedWindow<span class="token punctuation">,</span>
					fileInputs
				<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

				<span class="token comment">// Reset these because we handled them</span>
				fileInputs <span class="token operator">=</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span>
				openFolderInNewWindow <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span> <span class="token comment">// any other window to open must open in new window then</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>

		<span class="token keyword">return</span> arrays<span class="token punctuation">.</span><span class="token function">distinct</span><span class="token punctuation">(</span>usedWindows<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
</code></pre></div><p>在openInBrowserWindow中，创建一个CodeWindow实例并返回，并且还调用了doOpenInBrowserWindow这个方法，这个方法看下文介绍。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">private</span> <span class="token function">openInBrowserWindow</span><span class="token punctuation">(</span>options<span class="token punctuation">:</span> IOpenBrowserWindowOptions<span class="token punctuation">)</span><span class="token punctuation">:</span> ICodeWindow <span class="token punctuation">{</span>

		<span class="token operator">...</span>

		<span class="token comment">// Create the window</span>
		window <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>instantiationService<span class="token punctuation">.</span><span class="token function">createInstance</span><span class="token punctuation">(</span>CodeWindow<span class="token punctuation">,</span> <span class="token punctuation">{</span>
			state<span class="token punctuation">,</span>
			extensionDevelopmentPath<span class="token punctuation">:</span> configuration<span class="token punctuation">.</span>extensionDevelopmentPath<span class="token punctuation">,</span>
			isExtensionTestHost<span class="token punctuation">:</span> <span class="token operator">!</span><span class="token operator">!</span>configuration<span class="token punctuation">.</span>extensionTestsPath
		<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token operator">...</span>

		<span class="token comment">// If the window was already loaded, make sure to unload it</span>
		<span class="token comment">// first and only load the new configuration if that was</span>
		<span class="token comment">// not vetoed</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>window<span class="token punctuation">.</span>isReady<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token keyword">this</span><span class="token punctuation">.</span>lifecycleMainService<span class="token punctuation">.</span><span class="token function">unload</span><span class="token punctuation">(</span>window<span class="token punctuation">,</span> UnloadReason<span class="token punctuation">.</span><span class="token constant">LOAD</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">veto</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
				<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>veto<span class="token punctuation">)</span> <span class="token punctuation">{</span>
					<span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">doOpenInBrowserWindow</span><span class="token punctuation">(</span>window<span class="token operator">!</span><span class="token punctuation">,</span> configuration<span class="token punctuation">,</span> options<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span>
			<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
			<span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">doOpenInBrowserWindow</span><span class="token punctuation">(</span>window<span class="token punctuation">,</span> configuration<span class="token punctuation">,</span> options<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>

		<span class="token keyword">return</span> window<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
</code></pre></div><p>接下来我们找到CodeWindow定义在src/vs/code/electron-main/window.ts中，在CodeWindow的构造函数中调用了createBrowserWindow方法，然后在createBrowserWindow方法中看到实例化了一个<a href="https://electronjs.org/docs/api/browser-window" target="_blank" rel="noopener noreferrer">BrowserWindow<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>，这是Electron中浏览器窗口的定义。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">//src/vs/code/electron-main/window.ts</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">CodeWindow</span> <span class="token keyword">extends</span> <span class="token class-name">Disposable</span> <span class="token keyword">implements</span> <span class="token class-name">ICodeWindow</span> <span class="token punctuation">{</span>

	<span class="token operator">...</span>

	<span class="token function">constructor</span><span class="token punctuation">(</span>
		<span class="token parameter">config<span class="token punctuation">:</span> IWindowCreationOptions<span class="token punctuation">,</span>
		@ILogService <span class="token keyword">private</span> readonly logService<span class="token punctuation">:</span> ILogService<span class="token punctuation">,</span>
		@IEnvironmentService <span class="token keyword">private</span> readonly environmentService<span class="token punctuation">:</span> IEnvironmentService<span class="token punctuation">,</span>
		@IFileService <span class="token keyword">private</span> readonly fileService<span class="token punctuation">:</span> IFileService<span class="token punctuation">,</span>
		@IConfigurationService <span class="token keyword">private</span> readonly configurationService<span class="token punctuation">:</span> IConfigurationService<span class="token punctuation">,</span>
		@IThemeMainService <span class="token keyword">private</span> readonly themeMainService<span class="token punctuation">:</span> IThemeMainService<span class="token punctuation">,</span>
		@IWorkspacesMainService <span class="token keyword">private</span> readonly workspacesMainService<span class="token punctuation">:</span> IWorkspacesMainService<span class="token punctuation">,</span>
		@IBackupMainService <span class="token keyword">private</span> readonly backupMainService<span class="token punctuation">:</span> IBackupMainService<span class="token punctuation">,</span></span>
	<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token keyword">this</span><span class="token punctuation">.</span>touchBarGroups <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
		<span class="token keyword">this</span><span class="token punctuation">.</span>_lastFocusTime <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
		<span class="token keyword">this</span><span class="token punctuation">.</span>_readyState <span class="token operator">=</span> ReadyState<span class="token punctuation">.</span><span class="token constant">NONE</span><span class="token punctuation">;</span>
		<span class="token keyword">this</span><span class="token punctuation">.</span>whenReadyCallbacks <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

		<span class="token comment">// create browser window</span>
		<span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">createBrowserWindow</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token comment">// respect configured menu bar visibility</span>
		<span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">onConfigurationUpdated</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token comment">// macOS: touch bar support</span>
		<span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">createTouchBar</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token comment">// Request handling</span>
		<span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">handleMarketplaceRequests</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token comment">// Eventing</span>
		<span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">registerListeners</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">private</span> <span class="token function">createBrowserWindow</span><span class="token punctuation">(</span>config<span class="token punctuation">:</span> IWindowCreationOptions<span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span>

		<span class="token operator">...</span>
		<span class="token comment">// Create the browser window.</span>
		<span class="token keyword">this</span><span class="token punctuation">.</span>_win <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BrowserWindow</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token operator">...</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>现在窗口有了，那么什么时候加载页面呢？刚刚我们在上文提到，在openInBrowserWindow中，创建一个CodeWindow实例并返回，并且还调用了doOpenInBrowserWindow这个方法，那么我们看一下这个方法的定义。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">private</span> <span class="token function">doOpenInBrowserWindow</span><span class="token punctuation">(</span>window<span class="token punctuation">:</span> ICodeWindow<span class="token punctuation">,</span> configuration<span class="token punctuation">:</span> IWindowConfiguration<span class="token punctuation">,</span> options<span class="token punctuation">:</span> IOpenBrowserWindowOptions<span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span>
		<span class="token operator">...</span>
		<span class="token comment">// Load it</span>
		window<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span>configuration<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token operator">...</span>
	<span class="token punctuation">}</span>
</code></pre></div><p>这个方法有调用CodeWindow的load方法，然后看一下load方法的定义。会看到调用了this._win.loadURL，这个this._win就是CodeWindow创建的BrowserWindow窗口，这就找到了窗口加载的URL时机。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function">load</span><span class="token punctuation">(</span>config<span class="token punctuation">:</span> IWindowConfiguration<span class="token punctuation">,</span> isReload<span class="token operator">?</span><span class="token punctuation">:</span> boolean<span class="token punctuation">,</span> disableExtensions<span class="token operator">?</span><span class="token punctuation">:</span> boolean<span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span>
	<span class="token operator">...</span>
	<span class="token comment">// Load URL</span>
	perf<span class="token punctuation">.</span><span class="token function">mark</span><span class="token punctuation">(</span><span class="token string">'main:loadWindow'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">this</span><span class="token punctuation">.</span>_win<span class="token punctuation">.</span><span class="token function">loadURL</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getUrl</span><span class="token punctuation">(</span>configuration<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token operator">...</span>
<span class="token punctuation">}</span>
</code></pre></div><p>然后看一下getUrl方法的定义，最终返回的configUrl是调用doGetUrl获取的。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">private</span> <span class="token function">getUrl</span><span class="token punctuation">(</span>windowConfiguration<span class="token punctuation">:</span> IWindowConfiguration<span class="token punctuation">)</span><span class="token punctuation">:</span> string <span class="token punctuation">{</span>

		<span class="token operator">...</span>
		<span class="token keyword">let</span> configUrl <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">doGetUrl</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token operator">...</span>

		<span class="token keyword">return</span> configUrl<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
</code></pre></div><p>然后看一下doGetUrl方法，可以看到返回的Url路径为vs/code/electron-browser/workbench/workbench.html。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">private</span> <span class="token function">doGetUrl</span><span class="token punctuation">(</span>config<span class="token punctuation">:</span> object<span class="token punctuation">)</span><span class="token punctuation">:</span> string <span class="token punctuation">{</span>
	<span class="token keyword">return</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>require<span class="token punctuation">.</span><span class="token function">toUrl</span><span class="token punctuation">(</span><span class="token string">'vs/code/electron-browser/workbench/workbench.html'</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">?config=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token function">encodeURIComponent</span><span class="token punctuation">(</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>这是整个 Workbench 的入口，HTML出现了，主进程的使命完成，渲染进程登场。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">//src/vs/code/electron-browser/workbench/workbench.html</span>
<span class="token operator">&lt;</span><span class="token operator">!</span><span class="token operator">--</span> <span class="token function">Copyright</span> <span class="token punctuation">(</span><span class="token constant">C</span><span class="token punctuation">)</span> Microsoft Corporation<span class="token punctuation">.</span> All rights reserved<span class="token punctuation">.</span> <span class="token operator">--</span><span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">!</span><span class="token constant">DOCTYPE</span> html<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>html<span class="token operator">&gt;</span>
	<span class="token operator">&lt;</span>head<span class="token operator">&gt;</span>
		<span class="token operator">&lt;</span>meta charset<span class="token operator">=</span><span class="token string">&quot;utf-8&quot;</span> <span class="token operator">/</span><span class="token operator">&gt;</span>
		<span class="token operator">&lt;</span>meta http<span class="token operator">-</span>equiv<span class="token operator">=</span><span class="token string">&quot;Content-Security-Policy&quot;</span> content<span class="token operator">=</span><span class="token string">&quot;default-src 'none'; img-src 'self' https: data: blob: vscode-remote-resource:; media-src 'none'; frame-src 'self' https://*.vscode-webview-test.com; object-src 'self'; script-src 'self'; style-src 'self' 'unsafe-inline'; connect-src 'self' https:; font-src 'self' https: vscode-remote-resource:;&quot;</span><span class="token operator">&gt;</span>
	<span class="token operator">&lt;</span><span class="token operator">/</span>head<span class="token operator">&gt;</span>
	<span class="token operator">&lt;</span>body <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">&quot;vs-dark&quot;</span> aria<span class="token operator">-</span>label<span class="token operator">=</span><span class="token string">&quot;&quot;</span><span class="token operator">&gt;</span>
	<span class="token operator">&lt;</span><span class="token operator">/</span>body<span class="token operator">&gt;</span>

	<span class="token operator">&lt;</span><span class="token operator">!</span><span class="token operator">--</span> Startup via workbench<span class="token punctuation">.</span>js <span class="token operator">--</span><span class="token operator">&gt;</span>
	<span class="token operator">&lt;</span>script src<span class="token operator">=</span><span class="token string">&quot;workbench.js&quot;</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>html<span class="token operator">&gt;</span>
</code></pre></div><p>workbench.html中加载了workbench.js文件，这个文件负责加载真正的 Workbench 模块并调用其 main 方法初始化主界面。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// src/vs/code/electron-browser/workbench/workbench.js</span>
<span class="token keyword">const</span> bootstrapWindow <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'../../../../bootstrap-window'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Setup shell environment</span>
process<span class="token punctuation">[</span><span class="token string">'lazyEnv'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">getLazyEnv</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Load workbench main JS, CSS and NLS all in parallel. This is an</span>
<span class="token comment">// optimization to prevent a waterfall of loading to happen, because</span>
<span class="token comment">// we know for a fact that workbench.desktop.main will depend on</span>
<span class="token comment">// the related CSS and NLS counterparts.</span>
bootstrapWindow<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
	<span class="token string">'vs/workbench/workbench.desktop.main'</span><span class="token punctuation">,</span>
	<span class="token string">'vs/nls!vs/workbench/workbench.desktop.main'</span><span class="token punctuation">,</span>
	<span class="token string">'vs/css!vs/workbench/workbench.desktop.main'</span>
<span class="token punctuation">]</span><span class="token punctuation">,</span>
	<span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">workbench<span class="token punctuation">,</span> configuration</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		perf<span class="token punctuation">.</span><span class="token function">mark</span><span class="token punctuation">(</span><span class="token string">'didLoadWorkbenchMain'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token keyword">return</span> process<span class="token punctuation">[</span><span class="token string">'lazyEnv'</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			perf<span class="token punctuation">.</span><span class="token function">mark</span><span class="token punctuation">(</span><span class="token string">'main/startup'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

			<span class="token comment">// @ts-ignore</span>
			<span class="token comment">//加载 Workbench 并初始化主界面</span>
			<span class="token keyword">return</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'vs/workbench/electron-browser/desktop.main'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">main</span><span class="token punctuation">(</span>configuration<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
		removeDeveloperKeybindingsAfterLoad<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
		<span class="token function-variable function">canModifyDOM</span><span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">windowConfig</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token function">showPartsSplash</span><span class="token punctuation">(</span>windowConfig<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span><span class="token punctuation">,</span>
		<span class="token function-variable function">beforeLoaderConfig</span><span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">windowConfig<span class="token punctuation">,</span> loaderConfig</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			loaderConfig<span class="token punctuation">.</span>recordStats <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span><span class="token punctuation">,</span>
		<span class="token function-variable function">beforeRequire</span><span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			perf<span class="token punctuation">.</span><span class="token function">mark</span><span class="token punctuation">(</span><span class="token string">'willLoadWorkbenchMain'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>我们可以看到加载了vs/workbench/electron-browser/desktop.main模块，并调用了模块的main方法。main方法中实例化了一个DesktopMain，并调用了DesktopMain的open方法。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">class</span> <span class="token class-name">DesktopMain</span> <span class="token keyword">extends</span> <span class="token class-name">Disposable</span> <span class="token punctuation">{</span>

	<span class="token keyword">async</span> <span class="token function">open</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span> Promise<span class="token operator">&lt;</span><span class="token keyword">void</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
		<span class="token operator">...</span>

		<span class="token comment">// Create Workbench</span>
		<span class="token keyword">const</span> workbench <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Workbench</span><span class="token punctuation">(</span>document<span class="token punctuation">.</span>body<span class="token punctuation">,</span> services<span class="token punctuation">.</span>serviceCollection<span class="token punctuation">,</span> services<span class="token punctuation">.</span>logService<span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token comment">// Listeners</span>
		<span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">registerListeners</span><span class="token punctuation">(</span>workbench<span class="token punctuation">,</span> services<span class="token punctuation">.</span>storageService<span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token comment">// Startup</span>
		<span class="token keyword">const</span> instantiationService <span class="token operator">=</span> workbench<span class="token punctuation">.</span><span class="token function">startup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token operator">...</span>
	<span class="token punctuation">}</span>
	<span class="token operator">...</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token parameter">configuration<span class="token punctuation">:</span> IWindowConfiguration</span><span class="token punctuation">)</span><span class="token punctuation">:</span> Promise<span class="token operator">&lt;</span><span class="token keyword">void</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
	<span class="token keyword">const</span> renderer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DesktopMain</span><span class="token punctuation">(</span>configuration<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> renderer<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>我们看到DesktopMain的open方法中实例化了Workbench类，并调用了Workbench的startup方法。接下来我们看一下这个Workbench类。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">Workbench</span> <span class="token keyword">extends</span> <span class="token class-name">Layout</span> <span class="token punctuation">{</span>

	<span class="token operator">...</span>
	<span class="token function">startup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span> IInstantiationService <span class="token punctuation">{</span>
		<span class="token keyword">try</span> <span class="token punctuation">{</span>

			<span class="token comment">// Configure emitter leak warning threshold</span>
			<span class="token function">setGlobalLeakWarningThreshold</span><span class="token punctuation">(</span><span class="token number">175</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

			<span class="token comment">// ARIA</span>
			<span class="token function">setARIAContainer</span><span class="token punctuation">(</span>document<span class="token punctuation">.</span>body<span class="token punctuation">)</span><span class="token punctuation">;</span>

			<span class="token comment">// Services</span>
			<span class="token keyword">const</span> instantiationService <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">initServices</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>serviceCollection<span class="token punctuation">)</span><span class="token punctuation">;</span>

			instantiationService<span class="token punctuation">.</span><span class="token function">invokeFunction</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token parameter">accessor</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
				<span class="token keyword">const</span> lifecycleService <span class="token operator">=</span> accessor<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>ILifecycleService<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token keyword">const</span> storageService <span class="token operator">=</span> accessor<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>IStorageService<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token keyword">const</span> configurationService <span class="token operator">=</span> accessor<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>IConfigurationService<span class="token punctuation">)</span><span class="token punctuation">;</span>

				<span class="token comment">// Layout</span>
				<span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">initLayout</span><span class="token punctuation">(</span>accessor<span class="token punctuation">)</span><span class="token punctuation">;</span>

				<span class="token comment">// Registries</span>
				<span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">startRegistries</span><span class="token punctuation">(</span>accessor<span class="token punctuation">)</span><span class="token punctuation">;</span>

				<span class="token comment">// Context Keys</span>
				<span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_register</span><span class="token punctuation">(</span>instantiationService<span class="token punctuation">.</span><span class="token function">createInstance</span><span class="token punctuation">(</span>WorkbenchContextKeysHandler<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

				<span class="token comment">// Register Listeners</span>
				<span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">registerListeners</span><span class="token punctuation">(</span>lifecycleService<span class="token punctuation">,</span> storageService<span class="token punctuation">,</span> configurationService<span class="token punctuation">)</span><span class="token punctuation">;</span>

				<span class="token comment">// Render Workbench</span>
				<span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">renderWorkbench</span><span class="token punctuation">(</span>instantiationService<span class="token punctuation">,</span> accessor<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>INotificationService<span class="token punctuation">)</span> <span class="token keyword">as</span> NotificationService<span class="token punctuation">,</span> storageService<span class="token punctuation">,</span> configurationService<span class="token punctuation">)</span><span class="token punctuation">;</span>

				<span class="token comment">// Workbench Layout</span>
				<span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">createWorkbenchLayout</span><span class="token punctuation">(</span>instantiationService<span class="token punctuation">)</span><span class="token punctuation">;</span>

				<span class="token comment">// Layout</span>
				<span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">layout</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

				<span class="token comment">// Restore</span>
				<span class="token keyword">try</span> <span class="token punctuation">{</span>
					<span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">restoreWorkbench</span><span class="token punctuation">(</span>accessor<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>IEditorService<span class="token punctuation">)</span><span class="token punctuation">,</span> accessor<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>IEditorGroupsService<span class="token punctuation">)</span><span class="token punctuation">,</span> accessor<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>IViewletService<span class="token punctuation">)</span><span class="token punctuation">,</span> accessor<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>IPanelService<span class="token punctuation">)</span><span class="token punctuation">,</span> accessor<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>ILogService<span class="token punctuation">)</span><span class="token punctuation">,</span> lifecycleService<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
					<span class="token function">onUnexpectedError</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span>
			<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

			<span class="token keyword">return</span> instantiationService<span class="token punctuation">;</span>
		<span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token function">onUnexpectedError</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>

			<span class="token keyword">throw</span> error<span class="token punctuation">;</span> <span class="token comment">// rethrow because this is a critical issue we cannot handle properly here</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	<span class="token operator">...</span>
<span class="token punctuation">}</span>
</code></pre></div><p>我们可以看到Workbench继承Layout布局类，在 workbench.startup 方法中构建主界面布局、创建全局事件监听以及实例化一些依赖的服务，全部完成后会还原之前打开的编辑器，整个 Workbench 加载完成。</p> <p>所以前文中的大量代码只是为这里最终创建主界面做铺垫，Workbench 模块主要代码都在 vs/workbench 目录下，主要负责界面元素的创建和具体业务功能的实现。</p> <p>至此，从启动到加载到html，再到构建主界面布局，整个流程很清晰。</p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/vscode-analysis/source/vscode-source-structure.html" class="prev">VSCode源码结构</a></span> <span class="next"><a href="/vscode-analysis/source/app-meta.html">应用信息定制</a>
      →
    </span></p></div> </main></div><div class="global-ui"><!----></div></div>
    <script src="/vscode-analysis/assets/js/app.1346b767.js" defer></script><script src="/vscode-analysis/assets/js/2.90bbf243.js" defer></script><script src="/vscode-analysis/assets/js/11.149737d3.js" defer></script>
  </body>
</html>
